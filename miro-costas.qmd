---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Miro


## Construcción colaborativa de Redes Bayesianas

::: {layout-ncol="2"}
La propuesta que hacemos es usar *Miro* como plataforma de debate y construcción de concenso. Buscamos así aproximarnos a la estructura causal que vincula las variables que determinan el rendimiento y la sustentabilidad (social, económica y ambiental). Una vez resuelta esta etapa, es necesario transferir lo acordado en *Miro* a plataformas de análisis estadístico. Aquí, nos propusimos trasladar los resultados de *Miro* a *R*. Al hacer esto las posibilidades analíticas se potencian muy ampliamente. Como veremos, podemos recurrir a `dagitty` o incluso utilizar *Python* y *Netica*. Para hacer esto optamos por la ruta de acceso commputacional [a través de la interfase "REST"](https://developers.miro.com/reference). Esto implica usar la biblioteca `httr` en *R*.

![](Images/colaboración.png)
:::

Hemos preparado una biblioteca con las rutinas que se describen aquí, para que las puedan usar según se requiera. Para descargarlas usa el botón que sigue.

\

```{r biblio_miro2Bayes, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

downloadthis::download_link(
      link = "https://github.com/equihuam/miro2bayesNet",
      button_label = "Descarga la biblioteca miro2bayes",
      button_type = "info",
      has_icon = TRUE,
      icon = "fa fa-save",
      self_contained = FALSE)

```

\

## Acceder a *Miro*

En preparación para usar **REST** se requiere tener permisos de acceso de acuerdo con las [especificaciones que se dan aquí](https://developers.miro.com/reference/scopes). Estas credenciales hay que evitar distribuirlas, así que en este ejercicio utilizo la biblioteca `keyring` para mantenerlas confidenciales. Esta biblioteca permite utilizar el sistema de seguridad del equipo para la gestión de las claves. Para dar de alta una llave utilicé en este caso la instrucción siguiente:

`key_set(service = "miro", username = "miguel-token")`

Una vez registrada en el equipo la llave, queda lista para su uso en cualquier momento con la función `key_get`.

Hay Explicaciones y ayuda para producir el código. [Se encuentran aquí](https://developers.miro.com/reference/get-access-token-context). Es muy amigable pues produce ejemplos concretos con los atributos particulares de interés del usuario.

Por ejemplo, veamos como recuperar los datos de acceso a un tablero particular simplemente verificando las credenciales que reconoce *Miro* al consultarle.

El resultado que regresa *Miro* es un `json` así que utilizaré la biblioteca `jsonlite`para convertirlo a un `dataframe`.

```{r Miro_usuario, echo=TRUE, message=FALSE, warning=FALSE}
library(devtools)
install_github("equihuam/miro2bayesNet", force = TRUE)

library(miro2bayes)
library(bnlearn)
library(bnviewer)
library(tidyverse)

tableros <- miroBoards(servMiro = "miro", user = "miguel-edu-token")
tableros[, c("name", "id")]

tablero_tr <- tableros %>%
              filter(str_detect(name, "Costa")) %>%
              select(id, name)

datos_miro <- getMiro(servMiro = "miro", user = "miguel-edu-token",
                        board = tablero_tr)

miroValidation(datos_miro)

neticaMiro <- miro2DNE(datos_miro)

write(neticaMiro, "costa-arenosa.dne")

netMiro_bn <- miro2bnlearn(datos_miro)
netMiro_bn

variables <- tibble(var = datos_miro$nodes$var)

graphviz.plot(netMiro_bn, layout = "dot")

```

## Resumen

### Conceptos y recomendaciones

Se demuestra la interacción con un [Tablero Miro](https://miro.com/app/board/uXjVMGRTvaE=/) desde **R** para generar una red bayesiana en forma colaborativa. Para facilitar el procedimiento se convino usar la siguiente rutina de integración del tablero:

1.  Una *Red Bayesiana* siempre es un **DAG** (grafo acíclico dirigido), consta de **nodos** (las notas adhesivas) y **arcos** los conectores que indican la existencia (a veces sólo la sospecha) de interacción causal entre variables. Estos arcos tienen una orientación, de ahí que los representemos por flechas con la *causa en la cola* y en *el efecto en la punta* (normalmente el resultado esperado, *la casa antecede al efecto*). Hay que asegurar en *Miro* que el contacto de cada conector con los dos nodos que vincula quede establecida. Miro sugiere contacto válido *destacando en gris* el nodo que toca la flecha. Una vez hecho el contacto, la flecha puede ubicarse en cualquier posición sobre el borde gris que aparece en torno al papelito. Puede ser que haya arcos que no quedaron adecuadamente ligados a sus *papelitos* de inicio o final. Esto es una inconsistencia técnica para los fine de extracción de datos.

::: {layout-ncol="2"}
2.  Cada Nodo deberá ser representado por una sola *Nota adhesiva* ("sticky note"). En este papelito se puede acomodar el texto descriptivo que se desee, pero conviene definir operacionalmente la variable y especificar la escala de medición y posible patrón de discretización o conjunto de niveles que puede tomar.

![](imagenes/Miro_sticky_note_marcada.png)
:::

\

::: {layout-ncol="2"}
3.  Cada nodo deberá tener una *etiqueta vinculada*, que especifique el nombre de la variable que lo representará en forma única. Deberá coincidir con la forma como se etiquetan los datos respectivos en la base de datos de que se disponga para el análisis. Se recomienda usar nombres cortos, alrededor de 10 caracteres alfanuméricos (ASCII para *Netica*), sin marcas diacríticas o símbolos, ni espacios. Como separador usar guión bajo.

![](imagenes/Miro_nota_etiquetada-rasgado_l%C3%A1piz.png)
:::

4.  En el enfoque causal que estamos proponiendo, las propiedades del *DAG* son importantes. El modelo bayesiano representa una propuesta del *proceso generador de la distribución de probabilidades conjunta del sistema*. Esto es importante, no sólo como una propiedad matemática del modelo, sino porque el *DAG* describe patrones específicos de correlación e independencia condicional que deben existir entre todos los factores involucrados, asumiendo que es válido el *DAG* propuesto. Además, en el diseño de políticas públicas interesa influir sobre el comportamiento del sistema. En todos los casos esto permite considerar los patrones específicos de independencia condicional que emergen, por implicación, de la estructura causal del sistema y que determinarán las consecuencias esperadas de las intervenciones planeadas.

5.  Con toda la información reunida en *Miro* es posible transferir la estructura de la red a *Netica*. No será una red completamente funcional, sólo incluirá los nodos con los nombres y vínculos acordados y registrados en *Miro*. Con base en esta información se tiene lo necesario para construir la red en la forma que convenga a varias plataformas de análisis: [bnlearn en *R*](https://www.bnlearn.com/) o [causalnex](https://causalnex.readthedocs.io/en/latest/index.html), [pomegranate](https://pomegranate.readthedocs.io/en/latest/), [pgmpy](https://pgmpy.org/) en Python.
